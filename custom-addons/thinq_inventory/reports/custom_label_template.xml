<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="report_product_label_custom">
            <t t-call="web.basic_layout">
                <!-- Ambil qty dari context -->
                <t t-set="qty" t-value="int(context.get('custom_quantity', 1))"/>
                <t t-set="total_labels" t-value="qty * len(docs)"/>
                <t t-set="labels_per_page" t-value="40"/>
                <t t-set="total_pages" t-value="int((total_labels - 1) / labels_per_page) + 1 if total_labels > 0 else 1"/>
                
                <!-- Debug line -->
                <!-- <div style="color: red; font-size: 12px; margin: 2mm;">DEBUG: qty = <t t-esc="qty"/>, total_labels = <t t-esc="total_labels"/>, pages = <t t-esc="total_pages"/></div> -->

                <!-- Loop untuk setiap halaman -->
                <t t-foreach="range(total_pages)" t-as="page_num">
                    <div class="page">
                        <!-- Container utama dengan table layout untuk grid 5x8 -->
                        <table style="width:190mm; height:144mm; margin:0; padding:0; border-collapse:collapse; table-layout:fixed; border:none;">
                            <!-- Hitung label untuk halaman ini -->
                            <t t-set="start_label" t-value="page_num * labels_per_page"/>
                            <t t-set="end_label" t-value="min((page_num + 1) * labels_per_page, total_labels)"/>
                            
                            <!-- Loop untuk 8 baris -->
                            <t t-foreach="range(8)" t-as="row">
                                <tr style="height:18mm; border:none;">
                                    <!-- Loop untuk 5 kolom -->
                                    <t t-foreach="range(5)" t-as="col">
                                        <t t-set="current_label" t-value="start_label + (row * 5 + col)"/>
                                        
                                        <td style="width:38mm; height:18mm; padding:0; margin:0; border:none; vertical-align:middle;">
                                            <!-- Jika masih ada label yang perlu dicetak di halaman ini -->
                                            <t t-if="current_label &lt; end_label">
                                                <!-- Tentukan produk untuk label ini -->
                                                <t t-set="product_index" t-value="int(current_label / qty)"/>
                                                <t t-set="current_product" t-value="docs[product_index]"/>
                                                
                                                <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-family:Arial, sans-serif; font-size:8px; padding:1mm; box-sizing:border-box;">
                                                    <div style="width:100%; text-align:center;">
                                                        <!-- Product Name -->
                                                        <div style="font-weight:bold; font-size:9px; line-height:1; margin-bottom:1mm; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                            <t t-esc="current_product.name"/>
                                                        </div>

                                                        <!-- Barcode -->
                                                        <t t-set="barcode_value" t-value="current_product.barcode or current_product.default_code or str(current_product.id)"/>
                                                        <div style="height:7mm; margin:0 auto;">
                                                            <t t-if="barcode_value">
                                                                <div t-out="barcode_value" t-options="{
                                                                    'widget': 'barcode',
                                                                    'symbology': 'Code128',
                                                                    'width': 100, 
                                                                    'height': 25, 
                                                                    'quiet': 0,
                                                                    'style': 'max-width:36mm; height:7mm; margin: 0 auto;'
                                                                }"/>
                                                            </t>
                                                        </div>

                                                        <!-- Price -->
                                                        <div style="font-size:9px; font-weight:bold; margin-top:1mm;">
                                                            Rp <t t-esc="'{:,.0f}'.format(current_product.list_price or 0)"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                            
                                            <!-- Empty cell jika tidak ada label di slot ini -->
                                            <t t-else="">
                                                <div style="width:100%; height:100%;"></div>
                                            </t>
                                        </td>
                                    </t>
                                </tr>
                            </t>
                        </table>
                    </div>
                    
                    <!-- Page break jika bukan halaman terakhir -->
                    <t t-if="page_num &lt; total_pages - 1">
                        <div style="page-break-after: always;"></div>
                    </t>
                </t>
            </t>
        </template>
    </data>
</odoo>
