<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="portal_my_home_menu_pr" name="Portal layout : PR menu entries" inherit_id="portal.portal_breadcrumbs" priority="30">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'pr' or pr" t-attf-class="breadcrumb-item #{'active ' if not pr else ''}">
                <a t-if="pr" t-attf-href="/my/pr?{{ keep_query() }}">Purchase Requests</a>
                <t t-else="">Purchase Requests</t>
            </li>
            <li t-if="pr" class="breadcrumb-item active">
                <t t-esc="pr.name"/>
            </li>
            <li t-if="page_name == 'create_pr'" class="breadcrumb-item">Purchase Request</li>
        </xpath>
  </template>

    <template id="portal_my_home_pr" name="Purchase Request" customize_show="True" inherit_id="portal.portal_my_home" priority="10">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
        </xpath>
        <div id="portal_client_category" position="inside">
            <t t-call="portal.portal_docs_entry">
              <t t-set="icon" t-value="'/web/static/img/rfq.svg'"/>
              <t t-set="text">Follow your Requests</t>
              <t t-set="title">Purchase Request</t>
              <t t-set="url" t-value="'/my/pr'"/>
              <t t-set="placeholder_count" t-value="'pr_count'"/>
          </t>
        </div>
    </template>

    <template id="portal_my_prs" name="My Purchase Requests">
      <t t-call="portal.portal_layout">
          <t t-set="breadcrumbs_searchbar" t-value="True"/>

          <t t-call="portal.portal_searchbar">
              <t t-set="title" >Purchase Requests</t>
          </t>
          <t t-if="not prs">
              <p class="alert alert-warning">There are currently no purchase request for your account.</p>
          </t>

          <a href="/my/pr/create" class="btn btn-primary mb-3">Create</a>
          
          <t t-if="prs" t-call="portal.portal_table">
              <thead>
                  <tr class="active">
                    <th>
                        <span class='d-none d-md-inline'>Purchase Request #</span>
                        <span class='d-block d-md-none'>Ref.</span>
                    </th>
                      <th>Request Date</th>
                      <th class="text-end">Estimated Total</th>
                      <th>Status</th>
                  </tr>
              </thead>
              <t t-foreach="prs" t-as="pr">
                  <tr>
                      <td><a t-att-href="pr.get_portal_url()"><t t-esc="pr.name"/></a></td>
                      <td>
                        <span t-field="pr.date_start"/>
                      </td>
                      <td class="text-end">
                        <span t-field="pr.estimated_cost"/>
                      </td>
                      <td>
                        <span t-attf-class="badge
                            #{' bg-secondary' if pr.state == 'draft' else ''}
                            #{' bg-warning text-dark' if pr.state == 'to_approve' else ''}
                            #{' bg-success' if pr.state == 'approved' else ''}
                            #{' bg-info' if pr.state == 'in_progress' else ''}
                            #{' bg-primary' if pr.state == 'done' else ''}
                            #{' bg-danger' if pr.state == 'rejected' else ''}">
                            <span t-field="pr.state"/>
                        </span>
                      </td>
                  </tr>
              </t>
          </t>
      </t>
  </template>

  <template id="portal_create_pr_fields">
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
        <div t-if="error_message" class="alert alert-danger" role="alert">
            <div class="col-lg-12">
                <t t-foreach="error_message" t-as="err"><t t-esc="err"/><br /></t>
            </div>
        </div>

        <div t-attf-class="mb-3 #{error.get('name') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="name">Requested By</label>
            <input type="text" name="name" t-attf-class="form-control #{error.get('name') and 'is-invalid' or ''}" t-att-value="current_user.name" readonly="1" disabled="1"/>
        </div>

        <div t-attf-class="mb-3 #{error.get('assigned_to') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="assigned_to">Approver</label>
            <select t-attf-class="form-select #{error.get('origin') and 'is-invalid' or ''}" name="assigned_to" required="required">
                <option selected="selected" disabled="disabled" value="">-- Select Approver --</option>
                <t t-foreach="approvers" t-as="approver">
                    <option t-att-value="approver['id']">
                        <t t-esc="approver['display_name']"/>
                    </option>
                </t>
            </select>
        </div>

        <div t-attf-class="mb-3 #{error.get('expected_date') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="expected_date">Expected Date</label>
            <div class="input-group date" id="exp_closing_div">
                <input type="text" data-widget="datetime-picker" data-widget-type="date" name="expected_date" class="datetimepicker-input form-control date_deadline" />
                <span class="input-group-text o_input_group_date_icon">
                    <span class="fa fa-calendar" role="img" aria-label="Calendar"></span>
                </span>
            </div>
        </div>

        <div t-attf-class="mb-3 #{error.get('company_id') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="next_activity">Company</label>
            <select t-attf-class="form-select #{error.get('origin') and 'is-invalid' or ''}" name="company_id" required="required">
                <option selected="selected" disabled="disabled" value="">-- Select Company --</option>
                <t t-foreach="companies" t-as="company">
                    <option t-att-value="company['id']">
                        <t t-esc="company['name']"/>
                    </option>
                </t>
            </select>
        </div>

        <div t-attf-class="mb-3 #{error.get('origin') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="origin">Source Document</label>
            <input type="text" name="origin" t-attf-class="form-control #{error.get('origin') and 'is-invalid' or ''}"/>
        </div>

        <div t-attf-class="mb-3 #{error.get('description') and 'o_has_error' or ''} col-xl-6">
            <label class="col-form-label" for="description">Additional Notes</label>
            <textarea name="description" class="form-control"/>
        </div>

        <div class="mb-3 col-12">
            <label class="col-form-label fw-bold">Request Lines</label>
            <table class="table table-bordered align-middle" id="pr_lines_table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 35%">Product</th>
                        <th style="width: 15%">Qty</th>
                        <th style="width: 20%">Unit Price</th>
                        <!-- <th style="width: 20%">Estimated Cost</th> -->
                        <th style="width: 10%"></th>
                    </tr>
                </thead>
                <tbody id="pr_lines_body">
                    <tr>
                        <td>
                            <select name="product_id[]" class="form-select product-select" required="required"></select>
                        </td>
                        <td><input type="number" name="product_qty[]" class="form-control" min="1" value="1" required="required"/></td>
                        <td><input type="number" name="price_unit[]" class="form-control" min="0" step="0.01" required="required"/></td>
                        <!-- <td><input type="number" name="estimated_cost[]" class="form-control" min="0" step="0.01" required="required"/></td> -->
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger remove-line"><i class="fa fa-trash"/></button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" id="add_pr_line" class="btn btn-secondary btn-sm">
                <i class="fa fa-plus"></i> Add a line
            </button>
        </div>

  </template>

  <template id="portal_create_pr">
        <t t-call="portal.portal_layout">
            <t t-set="additional_title">Create New Purchase Request</t>
            <form action="/my/pr/submit" method="post">
                <div class="row o_portal_details">
                    <div class="col-lg-8">
                        <div class="row">
                            <t t-call="thinq_purchase.portal_create_pr_fields"/>
                        </div>
                        <div class="clearfix text-end mb-5">
                            <a href="/my/" class="btn btn-light me-2">
                                Discard
                            </a>
                            <button type="submit" class="btn btn-primary float-end">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </t>
    </template>

    <template id="portal_my_purchase_request" name="Purchase Request" inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <div class="row o_portal_pr_sidebar">
                <!-- Sidebar -->
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-4 col-xxl-3 d-print-none'"/>
                    <t t-set="title">
                        <h3 class="mb-0 text-break">
                            <span t-field="pr.estimated_cost"/>
                        </h3>
                    </t>
                    <t t-set="entries">
                        <div class="d-flex flex-column gap-3 mt-3">
                            <a class="btn btn-secondary o_print_btn"
                            t-att-href="pr.get_portal_url(report_type='pdf')"
                            id="print_pr_report"
                            title="Download / Print"
                            role="button"
                            target="_blank">
                                <i class="fa fa-print me-1"/>Download / Print
                            </a>

                            <div t-if="pr.requested_by">
                                <h6 class="small text-muted">Requested By</h6>
                                <t t-call="portal.portal_my_contact">
                                    <t t-set="_contactAvatar" t-value="image_data_uri(pr.requested_by.avatar_128)"/>
                                    <t t-set="_contactName" t-value="pr.requested_by.name"/>
                                    <t t-set="_contactLink" t-value="True"/>
                                    <div t-field="pr.requested_by"
                                        t-options='{"widget": "contact", "fields": ["phone"], "no_marker": False}'/>
                                </t>
                            </div>
                        </div>
                    </t>
                </t>

                <!-- Main content -->
                <div id="pr_content" class="o_portal_content col-12 col-lg-8 col-xxl-9">
                    <!-- Status alert -->
                    <div t-if="pr.state == 'rejected'" class="alert alert-danger d-print-none" role="alert">
                        <strong>This request has been rejected.</strong>
                    </div>

                    <div id="portal_pr_content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Purchase Request <em t-esc="pr.name"/></h3>
                            <span t-attf-class="badge
                                #{' bg-secondary' if pr.state == 'draft' else ''}
                                #{' bg-warning text-dark' if pr.state == 'to_approve' else ''}
                                #{' bg-success' if pr.state == 'approved' else ''}
                                #{' bg-info' if pr.state == 'in_progress' else ''}
                                #{' bg-primary' if pr.state == 'done' else ''}
                                #{' bg-danger' if pr.state == 'rejected' else ''}">
                                <span t-field="pr.state"/>
                            </span>
                        </div>

                        <!-- HEADER SECTION -->
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr>
                                    <th width="20%">Requested By:</th>
                                    <td><span t-field="pr.requested_by"/></td>
                                </tr>
                                <tr>
                                    <th>Approver:</th>
                                    <td><span t-field="pr.assigned_to"/></td>
                                </tr>
                                <tr>
                                    <th>Source Document:</th>
                                    <td><span t-field="pr.origin"/></td>
                                </tr>
                                <tr t-if="pr.description">
                                    <th>Adiitional Notes:</th>
                                    <td><span t-field="pr.description"/></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- LINES SECTION -->
                        <div class="mt-4">
                            <h4>Details</h4>
                            <table class="table table-striped table-sm mt-2">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-end">Quantity</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Estimated Cost</th>
                                        <th class="text-end">RFQ/PO Qty</th>
                                        <th>Purchase Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="pr.line_ids" t-as="line">
                                        <td><span t-field="line.product_id"/></td>
                                        <td class="text-end"><span t-field="line.product_qty"/></td>
                                        <td class="text-end">
                                            <span t-field="line.price_unit"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-field="line.estimated_cost"/>
                                        </td>
                                        <td class="text-end">
                                            <span t-field="line.purchased_qty"/>
                                        </td>
                                        <td>
                                            <span t-field="line.purchase_state"/>
                                        </td>
                                    </tr>
                                    <tr t-if="not pr.line_ids">
                                        <td colspan="4" class="text-center text-muted">No request lines</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Chatter -->
                        <hr class="my-4"/>
                        <div id="purchase_request_communication">
                            <h3>Communication History</h3>
                            <t t-call="portal.message_thread"/>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>


</odoo>
